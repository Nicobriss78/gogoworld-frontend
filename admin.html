<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard — GoGoWorld.life</title>

  <!-- Base API (già usata dal resto del FE) -->


  <link rel="stylesheet" href="style.css" />
  <style> 
    /* Mini-stili specifici admin (non invasivi) */
    .admin-wrap { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .admin-header { display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:1rem; }
    .admin-title { font-size:1.4rem; font-weight:700; }
    .admin-tabs { display:flex; gap:.5rem; }
    .admin-tabs button { padding:.5rem .75rem; border:1px solid #ddd; background:#f9f9f9; cursor:pointer; }
    .admin-tabs button.active { background:#111; color:#fff; border-color:#111; }
    .admin-toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin:.75rem 0; }
    .admin-grid { display:grid; grid-template-columns: 1fr; gap:.75rem; }
    .admin-card { border:1px solid #eee; border-radius:8px; padding:.75rem; background:#fff; }
    .admin-card h3 { margin:0 0 .5rem 0; font-size:1.05rem; }
    .badge { display:inline-block; padding:.15rem .5rem; font-size:.8rem; border-radius:999px; border:1px solid #ddd; background:#f5f5f5; }
    .badge.approved { background:#e9f9ef; border-color:#bde5c8; }
    .badge.pending { background:#fff6e5; border-color:#f3d19e; }
    .badge.rejected { background:#fdecec; border-color:#f4b5b5; }
    .badge.blocked { background:#eee; border-color:#ccc; }
    .actions { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
    .actions .btn { padding:.35rem .6rem; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .actions .btn.primary { background:#111; color:#fff; border-color:#111; }
    .kpis { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:.75rem; margin:.75rem 0; }
    .kpi { padding:.75rem; border:1px solid #eee; border-radius:8px; background:#fff; }
    .kpi strong { display:block; font-size:1.2rem; }
    @media (max-width: 768px) {
      .kpis { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { padding:.5rem; border-bottom:1px solid #eee; text-align:left; }
    .muted { color:#777; }
    .search-input { padding:.4rem .55rem; border:1px solid #ddd; border-radius:6px; min-width:220px; }
    .select-input { padding:.4rem .55rem; border:1px solid #ddd; border-radius:6px; }
    .right { margin-left:auto; }
    /* --- Dropdown Banner --- */
.menu-group { position:relative; }
.menu-toggle { padding:.5rem .75rem; border:1px solid #ddd; background:#f9f9f9; cursor:pointer; }
.menu-toggle.active { background:#111; color:#fff; border-color:#111; }
.menu-dropdown { position:absolute; top:110%; left:0; min-width:220px; border:1px solid #ddd; background:#fff; border-radius:8px; box-shadow:0 4px 18px rgba(0,0,0,.08); display:none; z-index:10; }
.menu-dropdown button { display:block; width:100%; text-align:left; padding:.5rem .75rem; border:0; background:#fff; cursor:pointer; }
.menu-dropdown button:hover { background:#f5f5f5; }
  </style>
</head>

<body>
  <div class="admin-wrap">
    <header class="admin-header">
      <div class="admin-title">Admin Dashboard</div>
      <nav class="admin-tabs" id="adminTabs">
<!-- Dropdown Sezioni -->
        <span class="menu-group">
          <button type="button" id="sectionsMenuBtn" class="menu-toggle">Sezioni ▾</button>
          <span class="menu-dropdown" id="sectionsMenu">
            <button type="button" data-tab="events">Eventi</button>
            <button type="button" data-tab="users">Utenti</button>
            <button type="button" data-tab="imports">Import Massivo</button>
            <button type="button" data-tab="reviews">Recensioni</button>
            <button type="button" data-tab="sponsor">Sponsor</button>
            <button type="button" data-tab="house">House</button>
            <button type="button" data-tab="approvals">Richieste da approvare</button>
          </span>
        </span>


      </nav>
      <button id="btnAdminLogout" class="btn">Logout</button>
    </header>

    <!-- KPI -->
    <section class="kpis" id="kpiBar" aria-label="KPI principali">
      <div class="kpi"><span class="muted">Pending</span><strong id="kpiPending">-</strong></div>
      <div class="kpi"><span class="muted">Approved</span><strong id="kpiApproved">-</strong></div>
      <div class="kpi"><span class="muted">Rejected</span><strong id="kpiRejected">-</strong></div>
      <div class="kpi"><span class="muted">Blocked</span><strong id="kpiBlocked">-</strong></div>
    </section>

    <!-- Tabs content -->
    <main id="adminContent" class="admin-grid">
      <!-- Tab: Eventi -->
      <section data-tab-panel="events">
        <div class="admin-toolbar">
          <input id="evSearch" class="search-input" type="search" placeholder="Cerca titolo, città, categoria..." />
          <select id="evStatus" class="select-input">
          <option value="">Tutti gli stati</option>
          <option value="approved">Approved</option>
          <option value="pending">Pending</option>
          <option value="rejected">Rejected</option>
          <option value="blocked">Blocked</option>
          </select>
          <select id="evVisibility" class="select-input">
          <option value="">All</option>
          <option value="public">Public</option>
          <option value="private">Private</option>
          </select>
          <button id="evRefresh" class="btn">Aggiorna</button>
          <span class="right muted">Seleziona un evento per moderarlo</span>
        </div>

        <div id="eventsList" class="admin-grid"></div>
      </section>

      <!-- Tab: Utenti -->
      <section data-tab-panel="users" hidden>
        <div class="admin-toolbar">
          <input id="usSearch" class="search-input" type="search" placeholder="Cerca nome o email..." />
          <select id="usRole" class="select-input">
            <option value="">Tutti i ruoli</option>
            <option value="participant">Participant</option>
            <option value="organizer">Organizer</option>
            <option value="admin">Admin</option>
          </select>
          <select id="usOrg" class="select-input">
            <option value="">Può organizzare?</option>
            <option value="true">Sì</option>
            <option value="false">No</option>
          </select>
          <select id="usBan" class="select-input">
            <option value="">Bannati?</option>
            <option value="true">Sì</option>
            <option value="false">No</option>
          </select>
          <select id="usStatus" class="select-input">
            <option value="">Tutti gli status</option>
            <option value="novizio">Novizio</option>
            <option value="esploratore">Esploratore</option>
            <option value="veterano">Veterano</option>
            <option value="ambassador">Ambassador</option>
          </select>
          <input id="usScoreMin" class="search-input" type="number" min="0" step="1" placeholder="Score min" />
          <input id="usScoreMax" class="search-input" type="number" min="0" step="1" placeholder="Score max" />
          <button id="usRefresh" class="btn">Aggiorna</button>
          <button id="usReset" class="btn">Reset</button>
          <button id="usExport" class="btn">Export CSV</button>

        </div>

        <div id="usersList" class="admin-grid"></div>
        <div id="usersPager" class="pager"></div>
      </section>

      <!-- Tab: Import Massivo -->
      <section data-tab-panel="imports" hidden>
        <div class="admin-toolbar">
          <!-- PATCH 1: rinominato Simulazione in Validazione -->
          <input id="impSimulate" type="checkbox" checked /> <label for="impSimulate">Validazione</label>
          
          <!-- PATCH 2: eliminato testo tra parentesi -->
          <button id="impRun" class="btn">Esegui import CSV</button>
          <input id="impFile" type="file" accept=".csv,text/csv" />
          <span id="impFileName" class="muted">Nessun file selezionato</span>
        </div>

        <div id="importResults" class="admin-card">
          <h3>Risultati import</h3>
          <pre id="importLog" class="muted">Nessun import eseguito.</pre>
        </div>
      </section>
      <!-- Tab: Recensioni -->
      <section data-tab-panel="reviews" hidden>
<div class="admin-toolbar">
    <label for="revEvent" class="muted">Evento:</label>
    <select id="revEvent">
      <option value="all">Tutti</option>
    </select>
    <button id="revRefresh" class="btn">Aggiorna</button>
    <span class="right muted">Recensioni pending in attesa di moderazione</span>
  </div>
        <div id="reviewsList" class="admin-grid"></div>
      </section>
      <!-- Tab: Sponsor (admin_third_party) -->
      <section data-tab-panel="sponsor" hidden>
        <div class="admin-card">
          <h3>Crea Sponsorizzazione Terzi</h3>
          <div class="admin-grid">
            <label>Titolo <input id="spTitle" class="search-input" type="text" placeholder="Titolo banner" /></label>
            <label>Immagine (URL https) <input id="spImage" class="search-input" type="url" placeholder="https://..." /></label>
            <label>Destinazione (URL https) <input id="spTarget" class="search-input" type="url" placeholder="https://..." /></label>
            <label>Placement
              <select id="spPlacement" class="select-input">
                <option value="events_list_inline">events_list_inline</option>
              </select>
            </label>
            <label>Paese (ISO-2) <input id="spCountry" class="search-input" type="text" placeholder="IT" /></label>
            <label>Regione <input id="spRegion" class="search-input" type="text" placeholder="Basilicata" /></label>
            <label>Inizio <input id="spFrom" class="search-input" type="datetime-local" /></label>
            <label>Fine <input id="spTo" class="search-input" type="datetime-local" /></label>
            <label>Priorità <input id="spPriority" class="search-input" type="number" value="100" /></label>
            <label><input id="spActive" type="checkbox" checked /> Attivo</label>
          </div>
          <div class="actions">
            <button id="spCreate" class="btn primary">Crea sponsor</button>
            <span class="muted">type=sponsor • source=admin_third_party • pagamento esterno</span>
          </div>
        </div>

        <div class="admin-card">
          <h3>Elenco Sponsor</h3>
          <div class="admin-toolbar">
            <button id="spRefresh" class="btn">Aggiorna</button>
          </div>
          <div id="sponsorList" class="admin-grid"></div>
        </div>
      </section>

      <!-- Tab: House (annunci piattaforma) -->
      <section data-tab-panel="house" hidden>
        <div class="admin-card">
          <h3>Crea Annuncio Piattaforma (House)</h3>
          <div class="admin-grid">
            <label>Titolo <input id="hsTitle" class="search-input" type="text" placeholder="Titolo banner" /></label>
            <label>Immagine (URL https) <input id="hsImage" class="search-input" type="url" placeholder="https://..." /></label>
            <label>Destinazione (URL https) <input id="hsTarget" class="search-input" type="url" placeholder="https://..." /></label>
            <label>Placement
              <select id="hsPlacement" class="select-input">
                <option value="events_list_inline">events_list_inline</option>
              </select>
            </label>
            <label>Paese (ISO-2) <input id="hsCountry" class="search-input" type="text" placeholder="IT" /></label>
            <label>Regione <input id="hsRegion" class="search-input" type="text" placeholder="Basilicata" /></label>
            <label>Inizio <input id="hsFrom" class="search-input" type="datetime-local" /></label>
            <label>Fine <input id="hsTo" class="search-input" type="datetime-local" /></label>
            <label>Priorità <input id="hsPriority" class="search-input" type="number" value="100" /></label>
            <label><input id="hsActive" type="checkbox" checked /> Attivo</label>
          </div>
          <div class="actions">
            <button id="hsCreate" class="btn primary">Crea house</button>
            <span class="muted">type=house • source=admin_house</span>
          </div>
        </div>

        <div class="admin-card">
          <h3>Elenco Annunci House</h3>
          <div class="admin-toolbar">
            <button id="hsRefresh" class="btn">Aggiorna</button>
          </div>
          <div id="houseList" class="admin-grid"></div>
        </div>
      </section>

      <!-- Tab: Richieste da approvare (organizer) -->
      <section data-tab-panel="approvals" hidden>
        <div class="admin-card">
          <h3>Richieste Organizzatori — In attesa</h3>
          <div class="admin-toolbar">
            <button id="apRefresh" class="btn">Aggiorna</button>
          </div>
          <div id="approvalsList" class="admin-grid"></div>
        </div>
      </section>
    </main>
  </div>

  <script type="module" src="js/admin.js"></script>
  <script>
    // Listener globale per retry API (503/502/504)
    window.addEventListener("api:status", (e) => {
      const { phase, attempt, status } = e.detail || {};
      if (phase === "retry") {
        try {
          showAlert(`⏳ Server in riattivazione… (tentativo ${attempt})`, "info", { autoHideMs: 1500 });
        } catch {
          console.info("Server in riattivazione… tentativo", attempt, "status", status);
        }
      }
    });
    // --- Banner dropdown toggle ---
// --- Sezioni dropdown toggle ---
    (function(){
      const btn = document.getElementById("sectionsMenuBtn");
      const menu = document.getElementById("sectionsMenu");
      if (btn && menu) {
        btn.addEventListener("click", () => {
          const open = menu.style.display === "block";
          menu.style.display = open ? "none" : "block";
          btn.classList.toggle("active", !open);
        });
        document.addEventListener("click", (e) => {
          if (!menu.contains(e.target) && e.target !== btn) {
            menu.style.display = "none";
            btn.classList.remove("active");
          }
        });
        // Chiude il menu quando scegli una voce; l’handler dei tab
        // (già in admin.js) si attiva sul click di [data-tab]
        menu.addEventListener("click", () => {
          menu.style.display = "none";
          btn.classList.remove("active");
        });
      }
    })();

  </script>
</body>
</html>
